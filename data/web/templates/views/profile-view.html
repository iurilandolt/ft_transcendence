<div id="profile-view" class="standard-view">
	<div class="container-fluid h-100">
		<div class="row h-100">
			<div id="profile-left-container" class="col-md-3 d-flex flex-column align-items-center pt-3">
				<div class="profile-pic mb-3">
					<img src="{{ profile_pic }}" alt="Profile Picture" class="img-fluid rounded-circle">
				</div>
				<div class="profile-info text-center">
					<h2>{{ user.username }}</h2>
					<p>Rank: <span>{{ rank }}</span></p>
					{% if not own_profile %}
					<p>Status: <span>{% if status == "online" %} Online {% else %}Offline{% endif %}</span></p>
					{% endif %}
					{% if not own_profile %}
					<div class="mt-3">
						{% if friends.friendship_status == 'none' %}
						<button id="friend-button" class="btn btn-primary" data-action="send-request" data-request-id="{{ user.username }}"> 
							<i class="fas fa-user-plus"></i> Add Friend
						</button>
						{% elif friends.friendship_status == 'pending_sent' %}
						<button id="friend-button" class="btn btn-secondary" data-action="cancel-request" data-request-id="{{ user.username }}">
							<i class="fas fa-clock"></i> Cancel Request
						</button>
						{% elif friends.friendship_status == 'pending_received' %}
						<div class="btn-group">
							<button id="accept-friend-button" class="btn btn-success" data-action="accept-request" data-request-id="{{ user.username }}">
								<i class="fas fa-check"></i> Accept
							</button>
							<button id="reject-friend-button" class="btn btn-danger" data-action="reject-request" data-request-id="{{ user.username }}">
								<i class="fas fa-times"></i> Reject
							</button>
						</div>
						{% elif friends.friendship_status == 'friends' %}
						<button id="friend-button" class="btn btn-outline-danger" data-action="remove-friend" data-request-id="{{ user.username }}">
							<i class="fas fa-user-minus"></i> Remove Friend
						</button>
						{% endif %}
					</div>
					{% endif %}

				</div>
			</div>
			<div class="col-md-9 d-flex flex-column">
				<div id="profile-top-container" class="row">
					<ul class="nav nav-tabs" id="profileTabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab" >About</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" >Stats</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" >Match History</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends" type="button" role="tab" >
								Friends 
								{% if own_profile and friends.pending_received.list %}
									<span class="badge bg-danger rounded-pill ms-1">{{ friends.pending_received.list|length }}</span>
								{% endif %}
							</button>
						</li>
						{% if own_profile %}
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" >Account</button>
						</li>
						{% endif %}
					</ul>
				</div>
				<div id="profile-right-container" class="row flex-grow-1">
					<div class="tab-content p-3">

						<!-- About Tab -->
						<div class="tab-pane fade show active" id="about" role="tabpanel">
							<h4>About {{ user.username }}</h4>
							<div class="card">
								<div class="card-body">
									<p>
										<strong style="color: #6c757d;">UUID:</strong> 
										<span style="color: #6c757d;">{{ about.uuid }}</span>
									</p>
									<p>
										<strong style="color: #6c757d;">First joined:</strong> 
										<span style="color: #6c757d;">{{ about.first_joined }}</span>
									</p>
									<p>
										<strong style="color: #6c757d;">Last seen:</strong>
										<span style="color: #6c757d;">{{ about.last_seen }}</span>
									</p>
								</div>
							</div>
						</div>

						<!-- Stats Tab -->
						<div class="tab-pane fade" id="stats" role="tabpanel">
							<h4>Player Statistics</h4>
							<div class="card">
								<div class="card-body">
									<div class="row text-center">
										<div class="col-md-4">
											<h5 style="color: #6c757d;">Total Games</h5>
											<p class="display-4" style="color: #6c757d;">{{ stats.total }}</p>
										</div>
										<div class="col-md-4">
											<h5 style="color: #6c757d;">Wins</h5>
											<p class="display-4 text-success">{{ stats.total_w }}</p>
										</div>
										<div class="col-md-4">
											<h5 style="color: #6c757d;">Losses</h5>
											<p class="display-4 text-danger">{{ stats.total_l }}</p>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- Match History Tab -->
						<div class="tab-pane fade" id="history" role="tabpanel">
							<h4>Match History</h4>

							<div class="table-responsive">
								<table class="table">
									<thead class="table-light">
										<tr>
											<th>Result</th>
											<th>Score</th>
											<th>Date</th>
											<th>Game ID</th>
											<th>Opponent</th>
										</tr>
									</thead>
									<tbody>
										{% for game in matches %}
										<tr class="{% if game.position == 'p1' %}table-primary{% else %}table-danger{% endif %}">
											<td>
												<span class="badge {% if game.result == 'win' %}bg-success{% else %}bg-dark{% endif %}">
													{% if game.result == 'win' %}üèÜ WIN{% else %}üí© LOSS{% endif %}
												</span>
											</td>
											<td>{{ game.score }}</td>
											<td>{{ game.date }}</td>
											<td>{{ game.game_id }}</td>
											<td>
												<a href="#/profile/{{ game.opponent }}/" style="text-decoration: none; color: inherit;">
													<div class="d-flex align-items-center">
														<div id="friend-image-container" class="me-3">
															<img id="friend-image" src="{{ game.opponent_pic }}" alt="{{ game.opponent }}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
														</div>
														<span>{{ game.opponent }}</span>
													</div>
												</a>	
											</td>
										</tr>
										{% empty %}
										<tr>
											<td colspan="5" class="text-center">No match history available</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>

						<!-- Friends Tab -->
						<div class="tab-pane fade" id="friends" role="tabpanel">
							<h4>Friends</h4>
							
							<!-- Friend Requests Section (only visible on own profile) -->
							{% if own_profile %}
								{% if friends.pending_received.list or friends.pending_sent.list %}
									<div class="card mb-4">
										<div class="card-header bg-light">
											<h5 class="mb-0">Friend Requests</h5>
										</div>
										<div class="list-group list-group-flush">
											{% with all_requests=friends.pending_received.list|add:friends.pending_sent.list %}
												{% for request in all_requests %}
													<div class="list-group-item d-flex justify-content-between align-items-center">
														<div class="d-flex align-items-center">
															<img src="{{ request.profile_pic }}" alt="{{ request.username }}" class="rounded-circle me-3" style="width: 32px; height: 32px; object-fit: cover;">
															<div>
																<a href="#/profile/{{ request.username }}/" class="text-decoration-none">{{ request.username }}</a>
																{% if request in friends.pending_received.list %}
																	<span class="badge bg-primary ms-2">Incoming</span>
																{% else %}
																	<span class="badge bg-secondary ms-2">Sent</span>
																{% endif %}
															</div>
														</div>
														<div>
															{% if request in friends.pending_received.list %}
															<button id="accept-friend-button" 
																	class="btn btn-sm btn-success me-1" 
																	data-action="accept-request"
																	data-request-id="{{ request.username }}">
																<i class="fas fa-check"></i> Accept
															</button>
															<button id="reject-friend-button" 
																	class="btn btn-sm btn-danger" 
																	data-action="reject-request"
																	data-request-id="{{ request.username }}">
																<i class="fas fa-times"></i> Reject
															</button>
															{% else %}
															<button id="cancel-friend-button" 
																	class="btn btn-sm btn-outline-secondary" 
																	data-action="cancel-request"
																	data-request-id="{{ request.username }}">
																<i class="fas fa-clock"></i> Cancel
															</button>
															{% endif %}
														</div>
													</div>
												{% endfor %}
											{% endwith %}
										</div>
									</div>
								{% endif %}
							{% endif %}
					
							<div class="list-group">
								{% if friends.list.list %}
									{% for friend in friends.list.list %}
									<a href="#/profile/{{ friend.username }}/" class="list-group-item list-group-item-action">
										<div class="d-flex align-items-center">
											<div id="friend-image-container" class="me-3">
												<img id="friend-image" src="{{ friend.profile_pic }}" alt="{{ friend.username }}" class="rounded-circle">
											</div>
							
											<div class="flex-grow-1 ms-3">
												<div class="d-flex justify-content-between align-items-center">
													<h6 class="mb-0">{{ friend.username }}</h6>
													<div>
														<span class="badge bg-secondary me-2">Rank: {{ friend.rank }}</span>
														<span class="badge {% if friend.status == 'online' %}bg-success{% else %}bg-secondary{% endif %} rounded-pill">
															{{ friend.status }}
														</span>
														{% if own_profile %}
														<button id="remove-friend-button" 
																class="btn-close bg-danger p-2 ms-2" 
																data-action="remove-friend"
																data-request-id="{{ friend.username }}" 
																title="Remove friend">
														</button>
														{% endif %}
													</div>
												</div>
											</div>
										</div>
									</a>
									{% endfor %}
								{% else %}
									<div class="list-group-item text-center">No friends yet</div>
								{% endif %}
							</div>
						</div>						

						<!-- Account Tab -->
						{% if own_profile %}
						<div class="tab-pane fade" id="account" role="tabpanel">
							<div class="d-flex justify-content-between align-items-center mb-3">
								<h4>Account Settings</h4>
								<div>
									<button type="button" id="edit-profile-btn" class="btn btn-primary">Edit Profile</button>
									<button type="button" id="save-profile-btn" class="btn btn-success d-none">Save Changes</button>
									<button type="button" id="cancel-edit-btn" class="btn btn-secondary d-none ms-2">Cancel</button>
								</div>
							</div>

							<div class="card">
								<div class="card-body">
									<form id="profile-form">
										<div class="mb-3">
											<label for="username" class="form-label fw-bold" style="color: #6c757d;">Username</label>
											<input type="text" class="form-control profile-field" id="username" value="{{ account.username }}" disabled>
										</div>

										<div class="mb-3">
											<label for="email" class="form-label fw-bold" style="color: #6c757d;">Email</label>
											<input type="email" class="form-control profile-field" id="email" value="{{ account.email }}" disabled>
										</div>

										<div class="mb-3">
											<label for="about" class="form-label fw-bold" style="color: #6c757d;">About Me</label>
											<textarea class="form-control profile-field" id="about" rows="3" disabled>{{ account.about_me|default:"there is no about me property :)" }}</textarea>
										</div>

										<div class="mb-4 d-none" id="profile-pic-section">
											<label class="form-label fw-bold" style="color: #6c757d;">Profile Picture</label>

											<button type="button" id="change-picture-btn" class="btn btn-outline-primary">Change Profile Picture</button>

											<div id="profile-pic-options" class="d-none mt-3 p-3 border rounded">
												<h6 class="form-label fw-bold mb-3" style="color: #6c757d;">Select new profile picture:</h6>
												<div class="row">
													{% for pic in account.profile_pictures %}
													<div class="col-md-2 mb-2">
														<div class="form-check">
															<input class="form-check-input" type="radio" name="profile-pic" id="pic-option-{{ forloop.counter }}" 
																   value="{{ pic }}" 
																   {% if pic in profile_pic %}checked{% endif %}>
															<label class="form-check-label" for="pic-option-{{ forloop.counter }}">
																<img src="/media/profile-pics/{{ pic }}" alt="Option {{ forloop.counter }}" 
																	 class="rounded-circle" 
																	 style="width: 60px; height: 60px; border: 3px solid #dee2e6; padding: 3px;">
															</label>
														</div>
													</div>
													{% endfor %}
												</div>
											</div>
										</div>
										<div class="text-center mt-4">
											<button type="button" id="security-btn" class="btn btn-warning d-inline-flex align-items-center">
												<span>Security Settings</span>
												<i class="fas fa-caret-down ms-2" style="font-size: 1.2rem;"></i>
											</button>

											<div id="security-options" class="mt-3 d-none">
												<div class="card">
													<div class="card-body">
														<div class="row">
															<div class="col-md-6">
																<div class="card h-100">
																	<div class="card-body p-4">
																		<div id="change-password-container" class="text-center">
																			<h5 class="mb-3 fw-bold" style="color: #495057;">
																				<i class="fas fa-key me-2"></i>Password Security
																			</h5>

																			<button type="button" id="change-password-btn" class="btn btn-outline-secondary w-100">
																				Change Password
																			</button>

																			<div id="password-fields" class="d-none mt-3">
																				<div class="mb-3">
																					<input type="password" class="form-control" id="current-password" placeholder="Current password">
																				</div>
																				<div class="mb-3">
																					<input type="password" class="form-control" id="new-password" placeholder="New password">
																				</div>
																				<div class="d-flex justify-content-between">
																					<button type="button" id="confirm-password-btn" class="btn btn-primary">
																						Confirm
																					</button>
																					<button type="button" id="cancel-password-btn" class="btn btn-outline-secondary">
																						Cancel
																					</button>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
															<div class="col-md-6">
																<div class="card h-100">
																	<div class="card-body p-4">
																		<div class="d-flex justify-content-between align-items-center mb-2">
																			<div>
																				<h5 class="mb-2 fw-bold" style="color: #495057;">
																					<i class="fas fa-shield-alt me-2"></i>Two-Factor Authentication
																				</h5>
																				<p class="mb-0" style="color: #495057; font-size: 0.9rem;">
																					A 2FA method is a good way to add an extra layer of security to your account.
																				</p>
																			</div>
																			<div class="form-check form-switch">
																				<input class="form-check-input" type="checkbox" id="twoFactorToggle" style="width: 3rem; height: 1.5rem;"
																					{% if user.two_factor_enable %}checked{% endif %}>
																				<label class="form-check-label" for="twoFactorToggle">
																					<span class="badge {% if user.two_factor_enable %}bg-success{% else %}bg-secondary{% endif %} ms-1">
																						{% if user.two_factor_enable %}ON{% else %}OFF{% endif %}
																					</span>
																				</label>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</form>
								</div>
							</div>
						</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
